
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at 2018-04-11
 Rendered using Maven Reflow Skin 1.0.0 (http://andriusvelykis.github.com/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">

	<head>
		<meta charset="UTF-8" />
		<title>Project Grizzly - Cookbook</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="" />
		<meta http-equiv="content-language" content="en" />
 
		<link href="//netdna.bootstrapcdn.com/bootswatch/2.2.2/cosmo/bootstrap.min.css" rel="stylesheet" />
		<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-responsive.min.css" rel="stylesheet" />
		<link href="https://javaee.github.io/grizzly//css/bootswatch.css" rel="stylesheet" />
		<link href="https://javaee.github.io/grizzly//css/reflow-skin.css" rel="stylesheet" />
		
		<link href="//yandex.st/highlightjs/7.3/styles/solarized_dark.min.css" rel="stylesheet" />
		
		<link href="https://javaee.github.io/grizzly//css/lightbox.css" rel="stylesheet" />
		
		<link href="https://javaee.github.io/grizzly//css/site.css" rel="stylesheet" />
		<link href="https://javaee.github.io/grizzly//css/print.css" rel="stylesheet" media="print" />
		
		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->

	</head>

	<body class="page-cookbook project-site" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</a>
					<a class="brand" href="index.html">Project <span class="color-brown">Grizzly</span></a>
					<div class="nav-collapse">
						<ul class="nav pull-right">
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Download <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="dependencies.html" title="Download">Download </a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="overview.html" title="Overview">Overview </a></li>
									<li><a href="dependencies.html" title="Dependencies">Dependencies </a></li>
									<li class="dropdown-submenu">
										<a href="hack" title="Core Framework">Core Framework </a>
										<ul class="dropdown-menu">
											<li><a href="memory.html" title="Memory Management">Memory Management </a></li>
											<li><a href="iostrategies.html" title="I/O Strategies">I/O Strategies </a></li>
											<li><a href="transportsconnections.html" title="Transports and Connections">Transports and Connections </a></li>
											<li><a href="filterchainfilters.html" title="FilterChain and Filters">FilterChain and Filters </a></li>
											<li><a href="coreconfig.html" title="Core configuration">Core configuration </a></li>
											<li><a href="portunification.html" title="Port Unification">Port Unification </a></li>
											<li><a href="monitoring.html" title="Monitoring">Monitoring </a></li>
											<li><a href="extras.html" title="Extras">Extras </a></li>
											<li><a href="bestpractices.html" title="Best Practices">Best Practices </a></li>
											<li><a href="quickstart.html" title="Quick Start">Quick Start </a></li>
											<li><a href="samples.html" title="Samples">Samples </a></li>
										</ul>
									</li>
									<li class="dropdown-submenu">
										<a href="hack" title="HTTP">HTTP </a>
										<ul class="dropdown-menu">
											<li><a href="httpframework.html" title="Core HTTP Framework">Core HTTP Framework </a></li>
											<li><a href="httpserverframework.html" title="HTTP Server Framework">HTTP Server Framework </a></li>
											<li><a href="http2.html" title="HTTP/2">HTTP/2 </a></li>
											<li><a href="httpserverframeworkextras.html" title="HTTP Server Framework Extras">HTTP Server Framework Extras </a></li>
											<li><a href="comet.html" title="Comet">Comet </a></li>
											<li><a href="jaxws.html" title="JAXWS">JAXWS </a></li>
											<li><a href="websockets.html" title="WebSockets">WebSockets </a></li>
											<li><a href="ajp.html" title="AJP">AJP </a></li>
										</ul>
									</li>
								</ul>
							</li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>
		
	<div class="container">
	
	<!-- Masthead
	================================================== -->
	<header class="jumbotron subhead">
		<div class="row" id="banner">
			<div class="span12">
				<div class="pull-left">
					<a href="index.html" id="bannerLeft"><h1><img src="images/grizzlyHead.png"/>&nbsp;<span class="color-black">Project</span> Grizzly</h1></a>
					<p class="lead">NIO Event Development Simplified</p>
				</div>
				<div class="pull-right">
				</div>
			</div>
		</div>
		<div>
			<ul class="breadcrumb">
				<li class="publishDate version-date">Last Published: 2018-04-11</li>
			</ul>
		</div>
		<hr class="toc-separator" />
		<div id="toc-bar" class="navbar">
			<div class="navbar-inner">
				<div id="toc-scroll-target" class="container">
					<ul id="toc" class="nav">
						<li class="toplevel"><a href="#Cookbook" title="Cookbook">Cookbook</a></li>
						<li class="toplevel"><a href="#Multi-threaded_client" title="Multi-threaded client">Multi-threaded client</a></li>
					</ul>
				</div>
			</div>
		</div>
	</header>

	<div class="main-body">
	<div class="row">
		<div class="span12">
			<div class="body-content">
<div class="section"> 
 <div class="page-header">
  <h2 id="Cookbook">Cookbook</h2>
 </div> 
 <p>Sample recipes on how to solve different use cases.</p> 
 <div class="section"> 
  <h3 id="Multi-threaded_client">Multi-threaded client</h3> 
  <p>This recipe presents how to write a multi-threaded client. That is, a client that have many threads issuing requests to a server at the same time. Each thread will register a listener for a server response and will receive a call back when the server responds to that request. The challenge for this recipe is that the filters in the filter chain should be stateless but still find the correct listener to invoke when a response comes from the server.</p> 
  <p>This sample assumes a simple Echo server is running, you can use a server implementation similar to the <a href="quickstart.html">Quick start</a> to try out the client.</p> 
  <p>The client sample code will start 10 threads, each thread will send a request to the server running on localhost port 7777. It will then wait for all listener callbacks and exit. The code is written using Java8 lambda expressions but you can use anonymous inner classes or whatever style you like to register a listener.</p> 
  <div class="source"> 
   <pre>public class CallbackClient {

	private final static int NUMBER_OF_CLIENT_THREADS = 10;
	private final CountDownLatch finishLatch = new CountDownLatch(NUMBER_OF_CLIENT_THREADS);
	private TCPNIOTransport transport;
	private final Attribute&lt;CallbackListener&gt; listenerAttribute
			= Grizzly.DEFAULT_ATTRIBUTE_BUILDER.createAttribute(&quot;listenerAttribute&quot;);

	public static void main(String... args) throws InterruptedException, IOException {
		CallbackClient app = new CallbackClient();
		app.startup();
		app.run();
	}

	private void startup() throws IOException {

		FilterChainBuilder clientFilterChainBuilder = FilterChainBuilder.stateless();
		// These are standard grizzly filters
		clientFilterChainBuilder.add(new TransportFilter());
		clientFilterChainBuilder.add(new StringFilter(Charset.defaultCharset(), &quot;\n&quot;));
		// This filter is defined below
		clientFilterChainBuilder.add(new CallbackFilter(listenerAttribute));
		transport = TCPNIOTransportBuilder.newInstance().build();
		transport.setProcessor(clientFilterChainBuilder.build());
		transport.start();
	}

	private void run() throws InterruptedException {
		for (int n = 0; n &lt; NUMBER_OF_CLIENT_THREADS; n++) {
			final String listenerID = &quot;Listener: &quot; + n;
			final String message = &quot;Hello from client: &quot; + n + &quot;\n&quot;;
			Thread clientThread = new Thread(() -&gt; {
				final GrizzlyFuture&lt;Connection&gt; connectionGrizzlyFuture = transport.connect(&quot;127.0.0.1&quot;, 7777);
				try {
					final Connection connection = connectionGrizzlyFuture.get();
					listenerAttribute.set(connection, (String serverMessage) -&gt; {
						System.out.println(listenerID + &quot; callback result: &quot; + serverMessage);
						finishLatch.countDown();
					});
					connection.write(message);
				} catch (InterruptedException | ExecutionException e) {
					e.printStackTrace();
				}
			}
			);
			clientThread.start();
		}

		finishLatch.await(5, TimeUnit.SECONDS);
		System.out.println(&quot;Exiting client&quot;);
	}

	public static class CallbackFilter extends BaseFilter {

		private final Attribute&lt;CallbackListener&gt; listenerAttribute;

		public CallbackFilter(Attribute&lt;CallbackListener&gt; listenerAttribute) {
			this.listenerAttribute = listenerAttribute;
		}

		@Override
		public NextAction handleRead(FilterChainContext ctx) throws IOException {
			final String message = ctx.getMessage();
			final CallbackListener callbackListener = listenerAttribute.get(ctx.getConnection());
			callbackListener.callback(message);
			return ctx.getStopAction();
		}
	}

	public interface CallbackListener {

		void callback(String message);
	}
}
</pre> 
  </div> 
  <p>As stated, the challenge in this recipe is to write stateless filters but still have the correct listener invoked when a response comes back from the server. To do that the client must find some unique instance of a class that the filter can pick up. Luckily the connection will be unique for each thread that sends a request to the server. So we will use the connection as a bucket for a data holder that the client thread will use to pass on a callback listener to the filter. The data holders are called ‘attributes’. An attribute is defined like this:</p> 
  <div class="source"> 
   <pre>private final Attribute&lt;CallbackListener&gt; listenerAttribute = Grizzly.DEFAULT_ATTRIBUTE_BUILDER.createAttribute(&quot;listenerAttribute&quot;);
</pre> 
  </div> 
  <p>The client then uses the transport it has set up to create a new connection to the server for each thread. When the connection has been created the client stores data on the connection using the attribute like this:</p> 
  <div class="source"> 
   <pre>final GrizzlyFuture&lt;Connection&gt; connectionGrizzlyFuture = transport.connect(&quot;127.0.0.1&quot;, 7777);
try {
	final Connection connection = connectionGrizzlyFuture.get();
	listenerAttribute.set(connection, (String message) -&gt; {
		System.out.println(listenerID + &quot; callback result: &quot; + message);
		finishLatch.countDown();
	});
</pre> 
  </div> 
  <p>In this sample it stores a reference to the callback listener that the filter will use when the server responds.</p> 
  <p>The callback filter used in the filter chain will extract the response from the server, retreive the listener stored on the connection, and invoke the listener passing on the data.</p> 
  <div class="source"> 
   <pre>public NextAction handleRead(FilterChainContext ctx) throws IOException {
	final String message = ctx.getMessage();
	final CallbackListener callbackListener = listenerAttribute.get(ctx.getConnection());
	callbackListener.callback(message);
</pre> 
  </div> 
  <p>Things to consider: - You might want to take care to issue the callback on another thread than the one the filter uses since that will hold up grizzly processing while the listener performs work. An aternative can be to use pass instances of ‘futures’ instead of listener callbacks and let the client thread wait for the future to complete.</p> 
 </div> 
</div>
			</div>
		</div>
	</div>
	</div>

	</div><!-- /container -->
	
	<!-- Footer
	================================================== -->
	<footer class="well">
		<div class="container">
			<div class="row">
				<div class="span4 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Main</li>
						<li>
							<a href="index.html" title="Home">Home </a>
						</li>
						<li>
							<a href="license.html" title="License">License </a>
						</li>
						<li>
							<a href="using.html" title="Who's Using Grizzly">Who's Using Grizzly </a>
						</li>
						<li class="nav-header">Download</li>
						<li>
							<a href="dependencies.html" title="Download">Download </a>
						</li>
					</ul>
				</div>
				<div class="span4 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Contribute</li>
						<li>
							<a href="contribute.html" title="Contribute">Contribute </a>
						</li>
						<li>
							<a href="http://stackoverflow.com/questions/tagged/grizzly" title="StackOverflow" class="externalLink">StackOverflow </a>
						</li>
						<li>
							<a href="https://twitter.com/project_grizzly" title="Twitter" class="externalLink">Twitter </a>
						</li>
						<li>
							<a href="mailing.html" title="Mailing Lists">Mailing Lists </a>
						</li>
					</ul>
				</div>
				<div class="span4 bottom-nav">
					<ul class="nav nav-list">
					</ul>
				</div>
				<div class="span0 bottom-description">
					<blockquote><div id="archive-footer">This project is now part of the <a href="https://projects.eclipse.org/projects/ee4j">EE4J</a> initiative; its activity is temporarily paused until it has been effectively transferred to the Eclipse Foundation.<br/>See <a href="https://www.eclipse.org/ee4j/status.php">here</a> for the EE4J transition status.
</div></blockquote>
				</div>
			</div>
		</div>
	</footer>
		
	<div class="container subfooter">
		<div class="row">
			<div class="span12">
				<p class="pull-right"><a href="#">Back to top</a></p>
				<p class="copyright">Copyright &copy;2018. All Rights Reserved.</p>
			</div>
		</div>
	</div>

	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->

	<!-- Fallback jQuery loading from Google CDN:
	     http://stackoverflow.com/questions/1014203/best-way-to-use-googles-hosted-jquery-but-fall-back-to-my-hosted-library-on-go -->
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script type="text/javascript">
		if (typeof jQuery == 'undefined')
		{
			document.write(unescape("%3Cscript src='https://javaee.github.io/grizzly//js/jquery-1.8.3.min.js' type='text/javascript'%3E%3C/script%3E"));
		}
	</script>
	
	<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
	<script src="https://javaee.github.io/grizzly//js/lightbox.js"></script>
	<script src="https://javaee.github.io/grizzly//js/jquery.smooth-scroll.min.js"></script>
	<!-- back button support for smooth scroll -->
	<script src="https://javaee.github.io/grizzly//js/jquery.ba-bbq.min.js"></script>
	<script src="//yandex.st/highlightjs/7.3/highlight.min.js"></script>

	<script src="https://javaee.github.io/grizzly//js/reflow-skin.js"></script>
	
	</body>
</html>
