
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at 2018-04-11
 Rendered using Maven Reflow Skin 1.0.0 (http://andriusvelykis.github.com/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">

	<head>
		<meta charset="UTF-8" />
		<title>Project Grizzly - Port Unification Overview</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="" />
		<meta http-equiv="content-language" content="en" />
 
		<link href="//netdna.bootstrapcdn.com/bootswatch/2.2.2/cosmo/bootstrap.min.css" rel="stylesheet" />
		<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-responsive.min.css" rel="stylesheet" />
		<link href="https://javaee.github.io/grizzly//css/bootswatch.css" rel="stylesheet" />
		<link href="https://javaee.github.io/grizzly//css/reflow-skin.css" rel="stylesheet" />
		
		<link href="//yandex.st/highlightjs/7.3/styles/solarized_dark.min.css" rel="stylesheet" />
		
		<link href="https://javaee.github.io/grizzly//css/lightbox.css" rel="stylesheet" />
		
		<link href="https://javaee.github.io/grizzly//css/site.css" rel="stylesheet" />
		<link href="https://javaee.github.io/grizzly//css/print.css" rel="stylesheet" media="print" />
		
		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->

	</head>

	<body class="page-portunification project-site" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</a>
					<a class="brand" href="index.html">Project <span class="color-brown">Grizzly</span></a>
					<div class="nav-collapse">
						<ul class="nav pull-right">
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Download <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="dependencies.html" title="Download">Download </a></li>
								</ul>
							</li>
							<li class="dropdown active">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="overview.html" title="Overview">Overview </a></li>
									<li><a href="dependencies.html" title="Dependencies">Dependencies </a></li>
									<li class="dropdown-submenu">
										<a href="hack" title="Core Framework">Core Framework </a>
										<ul class="dropdown-menu">
											<li><a href="memory.html" title="Memory Management">Memory Management </a></li>
											<li><a href="iostrategies.html" title="I/O Strategies">I/O Strategies </a></li>
											<li><a href="transportsconnections.html" title="Transports and Connections">Transports and Connections </a></li>
											<li><a href="filterchainfilters.html" title="FilterChain and Filters">FilterChain and Filters </a></li>
											<li><a href="coreconfig.html" title="Core configuration">Core configuration </a></li>
											<li class="active"><a href="" title="Port Unification">Port Unification </a></li>
											<li><a href="monitoring.html" title="Monitoring">Monitoring </a></li>
											<li><a href="extras.html" title="Extras">Extras </a></li>
											<li><a href="bestpractices.html" title="Best Practices">Best Practices </a></li>
											<li><a href="quickstart.html" title="Quick Start">Quick Start </a></li>
											<li><a href="samples.html" title="Samples">Samples </a></li>
										</ul>
									</li>
									<li class="dropdown-submenu">
										<a href="hack" title="HTTP">HTTP </a>
										<ul class="dropdown-menu">
											<li><a href="httpframework.html" title="Core HTTP Framework">Core HTTP Framework </a></li>
											<li><a href="httpserverframework.html" title="HTTP Server Framework">HTTP Server Framework </a></li>
											<li><a href="http2.html" title="HTTP/2">HTTP/2 </a></li>
											<li><a href="httpserverframeworkextras.html" title="HTTP Server Framework Extras">HTTP Server Framework Extras </a></li>
											<li><a href="comet.html" title="Comet">Comet </a></li>
											<li><a href="jaxws.html" title="JAXWS">JAXWS </a></li>
											<li><a href="websockets.html" title="WebSockets">WebSockets </a></li>
											<li><a href="ajp.html" title="AJP">AJP </a></li>
										</ul>
									</li>
								</ul>
							</li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>
		
	<div class="container">
	
	<!-- Masthead
	================================================== -->
	<header class="jumbotron subhead">
		<div class="row" id="banner">
			<div class="span12">
				<div class="pull-left">
					<a href="index.html" id="bannerLeft"><h1><img src="images/grizzlyHead.png"/>&nbsp;<span class="color-black">Project</span> Grizzly</h1></a>
					<p class="lead">NIO Event Development Simplified</p>
				</div>
				<div class="pull-right">
				</div>
			</div>
		</div>
		<div>
			<ul class="breadcrumb">
				<li class="publishDate version-date">Last Published: 2018-04-11</li>
			</ul>
		</div>
		<hr class="toc-separator" />
		<div id="toc-bar" class="navbar">
			<div class="navbar-inner">
				<div id="toc-scroll-target" class="container">
					<ul id="toc" class="nav">
						<li class="toplevel"><a href="#Port_Unification_Overview" title="Port Unification Overview">Port Unification Overview</a></li>
						<li class="divider-vertical"></li>
						<li class="toplevel"><a href="#How_it_works" title="How it works">How it works</a></li>
						<li class="divider-vertical"></li>
						<li class="toplevel"><a href="#Sample" title="Sample">Sample</a></li>
					</ul>
				</div>
			</div>
		</div>
	</header>

	<div class="main-body">
	<div class="row">
		<div class="span12">
			<div class="body-content">
<div class="section"> 
 <div class="page-header">
  <h2 id="Port_Unification_Overview">Port Unification Overview</h2>
 </div> 
 <p>When implementing a network application which provides several network services such as Web server (HTTP, HTTPS), Corba, JMS, we may think about how these services will be published.</p> 
 <p>The natural way of publishing different types of services - is to make them available on separate TCP ports (one TCP port per service). Usually HTTP is published on port 80, HTTPS 443, and so on. There might be no problems with that approach; the service consumer just must remember its own TCP port number, but sometimes, due to certain admin restrictions, we’re not able to make all the required TCP ports available for the external consumers on Internet. What if we’re limited just by one TCP port accessible for the external (Internet) service consumers? For that case, we have to have a solution which let’s us share a single TCP port among different services and, depending on incoming service request, redirect it to the corresponding service. This solution is called Port Unification.</p> 
</div> 
<div class="section"> 
 <h2 id="How_it_works">How it works</h2> 
 <p>Port Unification, in Grizzly, is represented by PUFilter which is a Grizzly 2.3 FilterChain Filter. This filter plays role of a fork in the FilterChain.</p> 
 <p>Each “unified” protocol, should be represented by a object pair:</p> 
 <ul> 
  <li> <p><b>ProtocolFinder</b>, which is responsible for parsing incoming data and figuring out if the data belongs to the specific protocol;</p></li> 
  <li> <p><b>FilterChain</b>, represents specific protocol FilterChain.</p></li> 
 </ul> 
 <p>So the final FilterChain will look like:</p> 
 <p><img src="images/portunification/portunification-diagram.png" alt="&quot;&quot;" /></p> 
 <p>For better usability, Grizzly Port Unification introduces the PUProtocol abstraction, which holds ProtocolFinder + FilterChain pair.</p> 
 <p>The picture above is not complete, one piece is missing. We can imagine how new data comes from network, comes into main FilterChain, it redirects it to the corresponding protocol FilterChain.</p> 
 <p>But what about opposite direction? Imagine HttpServerFilter wants to send data back to the client, so it constructs HttpPacket and send it by the custom protocol FilterChain. HttpFilter intercepts the HttpPacket, decodes it into a Buffer and… there is no Filter in the custom protocol FilterChain to pass the Buffer to, so it never comes to TransportFilter and never gets sent! In order to fix that, we need to add utility back channel Filter as the first Filter in the protocol FilterChain, which will be responsible for redirecting custom protocol FilterChain processing back to the main FilterChain. So finally complete picture will look like:</p> 
 <p><img src="images/portunification/portunification-diagram2.png" alt="&quot;&quot;" /></p> 
 <p>The PUFilter logic could be described using following flowchart diagram:</p> 
 <p><img src="images/portunification/pufilter-flowchart.png" alt="&quot;&quot;" /></p> 
</div> 
<div class="section"> 
 <h2 id="Sample">Sample</h2> 
 <p>Assume we have two services: add and sub, which are responsible for adding and subtracting passed integer values. The services protocol could be described by the following ABNF:</p> 
 <ul> 
  <li><b>add</b></li> 
 </ul> 
 <div class="source"> 
  <pre>        protocol  =  magic
                     value1
                     value2
        magic     =  &quot;add&quot;
        value1    =  INT
        value2    =  INT
        INT       =  4*BYTE
        BYTE      =  OCTET
</pre> 
 </div> 
 <ul> 
  <li><b>sub</b></li> 
 </ul> 
 <div class="source"> 
  <pre>        protocol  =  magic
                     value1
                     value2
        magic     =  &quot;sub&quot;
        value1    =  INT
        value2    =  INT
        INT       =  4*BYTE
        BYTE      =  OCTET
</pre> 
 </div> 
 <p>From the protocol description, it’s obvious we can distinguish two services and their protocols by 3-bytes magic header, add-service has “add”, sub-service “sub”. So it’s what service’s ProtocolFinder should address. For example add-service ProtocolFinder may look like:</p> 
 <div class="source"> 
  <pre>/**
 * {@link ProtocolFinder}, responsible to determine if incoming byte buffer
 * represents ADD-service request.
 */
public class AddProtocolFinder implements ProtocolFinder {

    private final static byte[] magic = {'a', 'd', 'd'};

    /**
     * {@inheritDoc}
     */
    @Override
    public Result find(final PUContext puContext, final FilterChainContext ctx) {
        // Get the input Buffer
        final Buffer inputBuffer = ctx.getMessage();

        final int bytesToCompare = Math.min(magic.length, inputBuffer.remaining());

        final int bufferStart = inputBuffer.position();

        // Compare incoming bytes with ADD-service protocol magic
        for (int i = 0; i &lt; bytesToCompare; i++) {
            if (magic[i] != inputBuffer.get(bufferStart + i)) {
                // If at least one byte doesn't match - it's not ADD-service protocol
                return Result.NOT_FOUND;
            }
        }

        // if we check entire magic - return FOUND, or NEED_MORE_DATA otherwise
        return bytesToCompare == magic.length ?
            Result.FOUND : Result.NEED_MORE_DATA;
    }

}
</pre> 
 </div> 
 <p>The add-service FilterChain will contain two Filters:</p> 
 <ul> 
  <li> <p><b>AddServerMessageFilter</b>, responsible for parsing/serializing add-service messages</p></li> 
  <li> <p><b>AddServiceFilter</b> the actual service implementation</p></li> 
 </ul> 
 <p>The PUProtocol initialization and registration for add-service will look following way:</p> 
 <div class="source"> 
  <pre>// Create PUFilter
final PUFilter puFilter = new PUFilter();

// Create ADD-service ProtocolFinder
final ProtocolFinder addProtocolFinder = new AddProtocolFinder();

// Create ADD-service FilterChain
final FilterChain addProtocolFilterChain =
        puFilter.getPUFilterChainBuilder()
        // Add ADD-service message parser/serializer
        .add(new AddServerMessageFilter())
        // Add ADD-service filter
        .add(new AddServiceFilter())
        .build();

// Construct PUProtocol
final PUProtocol addServicePUProtocol = new PUProtocol(addProtocolFinder, addProtocolFilterChain);

// Register add-service pu protocol
puFilter.register(addServicePUProtocol);
</pre> 
 </div> 
 <p>Similar coding is required for the sub-service. Finally port unification Filter (PUFilter) should be added to the main FilterChain and Transport could be started</p> 
 <div class="source"> 
  <pre>// Construct the main filter chain
final FilterChainBuilder puFilterChainBuilder = FilterChainBuilder.stateless()
        .add(new TransportFilter())
        .add(puFilter);

// Build TCP transport
final TCPNIOTransport transport = TCPNIOTransportBuilder.newInstance().build();
transport.setProcessor(puFilterChainBuilder.build());

// Bind to the server port
transport.bind(PORT);
// Start
transport.start();
</pre> 
 </div> 
 <p>Complete sample code could be found <a class="externalLink" href="https://maven.java.net/content/repositories/releases/org/glassfish/grizzly/samples/grizzly-portunif-samples/2.4.0">here</a>.</p> 
</div>
			</div>
		</div>
	</div>
	</div>

	</div><!-- /container -->
	
	<!-- Footer
	================================================== -->
	<footer class="well">
		<div class="container">
			<div class="row">
				<div class="span4 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Main</li>
						<li>
							<a href="index.html" title="Home">Home </a>
						</li>
						<li>
							<a href="license.html" title="License">License </a>
						</li>
						<li>
							<a href="using.html" title="Who's Using Grizzly">Who's Using Grizzly </a>
						</li>
						<li class="nav-header">Download</li>
						<li>
							<a href="dependencies.html" title="Download">Download </a>
						</li>
					</ul>
				</div>
				<div class="span4 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Contribute</li>
						<li>
							<a href="contribute.html" title="Contribute">Contribute </a>
						</li>
						<li>
							<a href="http://stackoverflow.com/questions/tagged/grizzly" title="StackOverflow" class="externalLink">StackOverflow </a>
						</li>
						<li>
							<a href="https://twitter.com/project_grizzly" title="Twitter" class="externalLink">Twitter </a>
						</li>
						<li>
							<a href="mailing.html" title="Mailing Lists">Mailing Lists </a>
						</li>
					</ul>
				</div>
				<div class="span4 bottom-nav">
					<ul class="nav nav-list">
					</ul>
				</div>
				<div class="span0 bottom-description">
					<blockquote><div id="archive-footer">This project is now part of the <a href="https://projects.eclipse.org/projects/ee4j">EE4J</a> initiative; its activity is temporarily paused until it has been effectively transferred to the Eclipse Foundation.<br/>See <a href="https://www.eclipse.org/ee4j/status.php">here</a> for the EE4J transition status.
</div></blockquote>
				</div>
			</div>
		</div>
	</footer>
		
	<div class="container subfooter">
		<div class="row">
			<div class="span12">
				<p class="pull-right"><a href="#">Back to top</a></p>
				<p class="copyright">Copyright &copy;2018. All Rights Reserved.</p>
			</div>
		</div>
	</div>

	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->

	<!-- Fallback jQuery loading from Google CDN:
	     http://stackoverflow.com/questions/1014203/best-way-to-use-googles-hosted-jquery-but-fall-back-to-my-hosted-library-on-go -->
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script type="text/javascript">
		if (typeof jQuery == 'undefined')
		{
			document.write(unescape("%3Cscript src='https://javaee.github.io/grizzly//js/jquery-1.8.3.min.js' type='text/javascript'%3E%3C/script%3E"));
		}
	</script>
	
	<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
	<script src="https://javaee.github.io/grizzly//js/lightbox.js"></script>
	<script src="https://javaee.github.io/grizzly//js/jquery.smooth-scroll.min.js"></script>
	<!-- back button support for smooth scroll -->
	<script src="https://javaee.github.io/grizzly//js/jquery.ba-bbq.min.js"></script>
	<script src="//yandex.st/highlightjs/7.3/highlight.min.js"></script>

	<script src="https://javaee.github.io/grizzly//js/reflow-skin.js"></script>
	
	</body>
</html>
