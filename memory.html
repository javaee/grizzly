
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at 2017-05-03
 Rendered using Maven Reflow Skin 1.0.0 (http://andriusvelykis.github.com/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">

	<head>
		<meta charset="UTF-8" />
		<title>Project Grizzly - Memory Management Overview</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="" />
		<meta http-equiv="content-language" content="en" />
 
		<link href="//netdna.bootstrapcdn.com/bootswatch/2.2.2/cosmo/bootstrap.min.css" rel="stylesheet" />
		<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-responsive.min.css" rel="stylesheet" />
		<link href="https://grizzly.java.net/css/bootswatch.css" rel="stylesheet" />
		<link href="https://grizzly.java.net/css/reflow-skin.css" rel="stylesheet" />
		
		<link href="//yandex.st/highlightjs/7.3/styles/solarized_dark.min.css" rel="stylesheet" />
		
		<link href="https://grizzly.java.net/css/lightbox.css" rel="stylesheet" />
		
		<link href="https://grizzly.java.net/css/site.css" rel="stylesheet" />
		<link href="https://grizzly.java.net/css/print.css" rel="stylesheet" media="print" />
		
		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->

	</head>

	<body class="page-memory project-site" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</a>
					<a class="brand" href="index.html">Project <span class="color-brown">Grizzly</span></a>
					<div class="nav-collapse">
						<ul class="nav pull-right">
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Download <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="dependencies.html" title="Download">Download </a></li>
								</ul>
							</li>
							<li class="dropdown active">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="overview.html" title="Overview">Overview </a></li>
									<li><a href="dependencies.html" title="Dependencies">Dependencies </a></li>
									<li class="dropdown-submenu">
										<a href="hack" title="Core Framework">Core Framework </a>
										<ul class="dropdown-menu">
											<li class="active"><a href="" title="Memory Management">Memory Management </a></li>
											<li><a href="iostrategies.html" title="I/O Strategies">I/O Strategies </a></li>
											<li><a href="transportsconnections.html" title="Transports and Connections">Transports and Connections </a></li>
											<li><a href="filterchainfilters.html" title="FilterChain and Filters">FilterChain and Filters </a></li>
											<li><a href="coreconfig.html" title="Core configuration">Core configuration </a></li>
											<li><a href="portunification.html" title="Port Unification">Port Unification </a></li>
											<li><a href="monitoring.html" title="Monitoring">Monitoring </a></li>
											<li><a href="extras.html" title="Extras">Extras </a></li>
											<li><a href="bestpractices.html" title="Best Practices">Best Practices </a></li>
											<li><a href="quickstart.html" title="Quick Start">Quick Start </a></li>
											<li><a href="samples.html" title="Samples">Samples </a></li>
										</ul>
									</li>
									<li class="dropdown-submenu">
										<a href="hack" title="HTTP">HTTP </a>
										<ul class="dropdown-menu">
											<li><a href="httpframework.html" title="Core HTTP Framework">Core HTTP Framework </a></li>
											<li><a href="httpserverframework.html" title="HTTP Server Framework">HTTP Server Framework </a></li>
											<li><a href="http2.html" title="HTTP/2">HTTP/2 </a></li>
											<li><a href="httpserverframeworkextras.html" title="HTTP Server Framework Extras">HTTP Server Framework Extras </a></li>
											<li><a href="comet.html" title="Comet">Comet </a></li>
											<li><a href="jaxws.html" title="JAXWS">JAXWS </a></li>
											<li><a href="websockets.html" title="WebSockets">WebSockets </a></li>
											<li><a href="ajp.html" title="AJP">AJP </a></li>
											<li><a href="spdy.html" title="SPDY">SPDY </a></li>
										</ul>
									</li>
									<li class="dropdown-submenu">
										<a href="hack" title="Javadocs/XREF">Javadocs/XREF </a>
										<ul class="dropdown-menu">
											<li><a href="https://grizzly.java.net/docs/2.3/apidocs" title="Grizzly 2.3 Javadoc" class="externalLink">Grizzly 2.3 Javadoc </a></li>
											<li><a href="https://grizzly.java.net/docs/2.3/xref" title="Grizzly 2.3 XRef" class="externalLink">Grizzly 2.3 XRef </a></li>
											<li><a href="https://grizzly.java.net/docs/2.2/apidocs" title="Grizzly 2.2 Javadoc" class="externalLink">Grizzly 2.2 Javadoc </a></li>
											<li><a href="https://grizzly.java.net/docs/2.2/xref" title="Grizzly 2.2 XRef" class="externalLink">Grizzly 2.2 XRef </a></li>
											<li><a href="https://grizzly.java.net/docs/1.9/apidocs" title="Grizzly 1.9 Javadoc" class="externalLink">Grizzly 1.9 Javadoc </a></li>
											<li><a href="https://grizzly.java.net/docs/1.9/xref" title="Grizzly 1.9 XRef" class="externalLink">Grizzly 1.9 XRef </a></li>
										</ul>
									</li>
								</ul>
							</li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>
		
	<div class="container">
	
	<!-- Masthead
	================================================== -->
	<header class="jumbotron subhead">
		<div class="row" id="banner">
			<div class="span12">
				<div class="pull-left">
					<a href="index.html" id="bannerLeft"><h1><img src="images/grizzlyHead.png"/>&nbsp;<span class="color-black">Project</span> Grizzly</h1></a>
					<p class="lead">NIO Event Development Simplified</p>
				</div>
				<div class="pull-right">
				</div>
			</div>
		</div>
		<div>
			<ul class="breadcrumb">
				<li class="publishDate version-date">Last Published: 2017-05-03</li>
			</ul>
		</div>
		<hr class="toc-separator" />
		<div id="toc-bar" class="navbar">
			<div class="navbar-inner">
				<div id="toc-scroll-target" class="container">
					<ul id="toc" class="nav">
						<li class="toplevel"><a href="#Memory_Management_Overview" title="Memory Management Overview">Memory Management Overview</a></li>
						<li class="divider-vertical"></li>
						<li class="dropdown">
							<a href="#MemoryManager" title="MemoryManager" class="dropdown-toggle" role="button" data-toggle="dropdown" data-target="#">MemoryManager <b class="caret"></b></a>
							<ul class="dropdown-menu" role="menu">
								<!-- Repeat the item, otherwise it is not clickable as the dropdown root -->
								<li><a href="#MemoryManager" title="MemoryManager">MemoryManager</a></li>
								<li class="divider"></li>
								<li><a href="#ByteBufferManager" title="ByteBufferManager">ByteBufferManager</a></li>
								<li><a href="#HeapMemoryManager" title="HeapMemoryManager">HeapMemoryManager</a></li>
								<li><a href="#ThreadLocal_Memory_Pools" title="ThreadLocal Memory Pools">ThreadLocal Memory Pools</a></li>
								<li><a href="#Memory_Manager_and_ThreadLocal_Memory_Pools_Working_Together" title="Memory Manager and ThreadLocal Memory Pools Working Together">Memory Manager and ThreadLocal Memory Pools Working Together</a></li>

							</ul>
						</li>
						<li class="divider-vertical"></li>
						<li class="dropdown">
							<a href="#Buffers" title="Buffers" class="dropdown-toggle" role="button" data-toggle="dropdown" data-target="#">Buffers <b class="caret"></b></a>
							<ul class="dropdown-menu" role="menu">
								<!-- Repeat the item, otherwise it is not clickable as the dropdown root -->
								<li><a href="#Buffers" title="Buffers">Buffers</a></li>
								<li class="divider"></li>
								<li><a href="#Buffer" title="Buffer">Buffer</a></li>
								<li><a href="#CompositeBuffer" title="CompositeBuffer">CompositeBuffer</a></li>

							</ul>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</header>

	<div class="main-body">
	<div class="row">
		<div class="span12">
			<div class="body-content">
<div class="section"> 
 <div class="page-header">
  <h2 id="Memory_Management_Overview">Memory Management Overview</h2>
 </div> 
 <p>Grizzly 2.0 introduces a new subsystem to improve memory management within the runtime. This subsystem is comprised of three main artifacts:</p> 
 <ul> 
  <li> <p>Buffers</p></li> 
  <li> <p>Thread local memory pools</p></li> 
  <li> <p>MemoryManager as a factory of sorts using the buffers and thread local pools</p></li> 
 </ul> 
 <p>whose primary purpose is to speed up memory allocation and, when possible, provide for memory re-use.</p> 
 <p>The following sections will describe these concepts in detail.</p> 
</div> 
<div class="section"> 
 <h2 id="MemoryManager">MemoryManager</h2> 
 <p>The <i>MemoryManager</i> is the main interface for allocating/de-allocating <i>Buffer</i> instances:</p> 
 <div class="source"> 
  <pre>public interface MemoryManager&lt;E extends Buffer&gt;
        extends JmxMonitoringAware&lt;MemoryProbe&gt; {

    /**
     * Allocated {@link Buffer} of the required size.
     *
     * @param size {@link Buffer} size to be allocated.
     * @return allocated {@link Buffer}.
     */
    public E allocate(int size);

    /**
     * Allocated {@link Buffer} at least of the provided size.
     * This could be useful for use cases like Socket.read(...), where
     * we're not sure how many bytes are available, but want to read as
     * much as possible.
     *
     * @param size the min {@link Buffer} size to be allocated.
     * @return allocated {@link Buffer}.
     */
    public E allocateAtLeast(int size);

    /**
     * Reallocate {@link Buffer} to a required size.
     * Implementation may choose the way, how reallocation could be done, either
     * by allocating new {@link Buffer} of required size and copying old
     * {@link Buffer} content there, or perform more complex logic related to
     * memory pooling etc.
     *
     * @param oldBuffer old {@link Buffer} to be reallocated.
     * @param newSize new {@link Buffer} required size.
     * @return reallocated {@link Buffer}.
     */
    public E reallocate(E oldBuffer, int newSize);

    /**
     * Release {@link Buffer}.
     * Implementation may ignore releasing and let JVM Garbage collector to take
     * care about the {@link Buffer}, or return {@link Buffer} to pool, in case
     * of more complex &lt;tt&gt;MemoryManager&lt;/tt&gt; implementation.
     *
     * @param buffer {@link Buffer} to be released.
     */
    public void release(E buffer);

    /**
     * Return &lt;tt&gt;true&lt;/tt&gt; if next {@link #allocate(int)} or {@link #allocateAtLeast(int)} call,
     * made in the current thread for the given memory size, going to return a {@link Buffer} based
     * on direct {@link java.nio.ByteBuffer}, or &lt;tt&gt;false&lt;/tt&gt; otherwise.
     *
     * @param size
     * @return
     */
    public boolean willAllocateDirect(int size);
}
</pre> 
 </div> 
 <p>There is typically a single <i>MemoryManager</i> servicing all transports defined within the Grizzly runtime. This <i>MemoryManager</i> can be obtained by referencing the static member of the MemoryManager interface:</p> 
 <div class="source"> 
  <pre>MemoryManager.DEFAULT_MEMORY_MANAGER
</pre> 
 </div> 
 <p>Conversely, custom <i>MemoryManager</i> implementations may be made as the default MemoryManager by defining the system property <i>org.glassfish.grizzly.DEFAULT_MEMORY_MANAGER</i> that references the fully qualified class name of the MemoryManager implementation to use. Note that this implementation must have a public no-arg constructor in order for the runtime to properly set the new default.</p> 
 <p>Grizzly 2.3 includes two <i>MemoryManager</i> implementations: <i>HeapMemoryManager</i> and <i>ByteBufferManager</i>. By default, the Grizzly runtime will use the <i>HeapMemoryManager</i>, however if a Grizzly application requires direct ByteBuffer access, then the <i>ByteBufferManager</i> can be used.</p> 
 <div class="section"> 
  <h3 id="ByteBufferManager">ByteBufferManager</h3> 
  <p>The <i>ByteBufferManager</i> implementation vends Grizzly Buffer instances that wrap JDK ByteBuffer instances. This is the MemoryManager to use if the Grizzly application requires direct ByteBuffer usage.</p> 
  <p>It should be noted that this MemoryManager, during our benchmarking, showed to have a little more overhead when using typical heap buffers. As such, if direct memory isn’t needed, we recommend that the default HeapMemoryManager be used.</p> 
 </div> 
 <div class="section"> 
  <h3 id="HeapMemoryManager">HeapMemoryManager</h3> 
  <p>The HeapMemoryManager is the default MemoryManager. Instead of wrapping ByteBuffer instances, this MemoryManager will allocate Buffer instances that wrap byte arrays directly. This MemoryManager offers better performance characteristics for operations such as trimming or splitting.</p> 
 </div> 
 <div class="section"> 
  <h3 id="ThreadLocal_Memory_Pools">ThreadLocal Memory Pools</h3> 
  <p>ThreadLocal memory pools provide the ability to allocate memory without any synchronization costs. Both the <i>ByteBufferManager</i> and <i>HeapMemoryManager</i> use such pools. Note that it’s not required that a custom <i>MemoryManager</i> use such pools, however, if said <i>MemoryManager</i> implements the <i>ThreadLocalPoolProvider</i> interface, then a <i>ThreadLocalPool</i> implementation must be provided. The <i>ThreadLocalPool</i> implementation will be created and passed to each thread being maintained by Grizzly’s managed threads.</p> 
 </div> 
 <div class="section"> 
  <h3 id="Memory_Manager_and_ThreadLocal_Memory_Pools_Working_Together">Memory Manager and ThreadLocal Memory Pools Working Together</h3> 
  <p>The following provides a flow diagram of how an allocation request to a <i>MemoryManager</i> with a <i>ThreadLocalPool</i> would typically work:</p> 
  <p><img src="images/coreframework/mmflow.png" alt="MemoryManager Allocation Request Flow" /></p> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Buffers">Buffers</h2> 
 <p>Grizzly 2.3 provides several buffers for developers to leverage when creating applications. These <i>Buffer</i> implementations offer features not available when using the JDK’s ByteBuffer.</p> 
 <div class="section"> 
  <h3 id="Buffer">Buffer</h3> 
  <p>The <i>Buffer</i> is essentially the analogue to the JDK’s ByteBuffer. It offers the same set of methods for:</p> 
  <ul> 
   <li> <p>Pushing/pulling data to/from the <i>Buffer</i>.</p></li> 
   <li> <p>Methods for accessing or manipulating the <i>Buffer’s</i> position, limit, and capacity.</p></li> 
  </ul> 
  <p>In addition to offering familiar semantics to ByteBuffer, the following features are available:</p> 
  <ul> 
   <li> <p>Splitting, trimming, and shrinking.</p></li> 
   <li> <p>Prepending another <i>Buffer’s</i> content to the current Buffer.</p></li> 
   <li> <p>Converting the <i>Buffer</i> to a ByteBuffer or ByteBuffer[].</p></li> 
   <li> <p>Converting <i>Buffer</i> content to a String.</p></li> 
  </ul> 
  <p>Please see the javadocs for further details on <i>Buffer</i>.</p> 
 </div> 
 <div class="section"> 
  <h3 id="CompositeBuffer">CompositeBuffer</h3> 
  <p>The <i>CompositeBuffer</i> is another <i>Buffer</i> implementation which allows appending of <i>Buffer</i> instances. The CompositeBuffer maintains a virtual position, limit, and capacity based on the <i>Buffers</i> that have been appended and can be treated as a simple <i>Buffer</i> instance.</p> 
  <p>Please see the javadocs for further details on <i>CompositeBuffer</i>.</p> 
 </div> 
</div>
			</div>
		</div>
	</div>
	</div>

	</div><!-- /container -->
	
	<!-- Footer
	================================================== -->
	<footer class="well">
		<div class="container">
			<div class="row">
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Main</li>
						<li>
							<a href="index.html" title="Home">Home </a>
						</li>
						<li>
							<a href="license.html" title="License">License </a>
						</li>
						<li>
							<a href="using.html" title="Who's Using Grizzly">Who's Using Grizzly </a>
						</li>
						<li class="nav-header">Download</li>
						<li>
							<a href="dependencies.html" title="Download">Download </a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Contribute</li>
						<li>
							<a href="contribute.html" title="Contribute">Contribute </a>
						</li>
						<li>
							<a href="http://stackoverflow.com/questions/tagged/grizzly" title="StackOverflow" class="externalLink">StackOverflow </a>
						</li>
						<li>
							<a href="https://twitter.com/project_grizzly" title="Twitter" class="externalLink">Twitter </a>
						</li>
						<li>
							<a href="mailing.html" title="Mailing Lists">Mailing Lists </a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Project Info</li>
						<li>
							<a href="scm.html" title="Source Control">Source Control </a>
						</li>
						<li>
							<a href="https://java.net/jira/browse/GRIZZLY/" title="Issue Tracking" class="externalLink">Issue Tracking </a>
						</li>
						<li>
							<a href="mailing.html" title="Mailing Lists">Mailing Lists </a>
						</li>
						<li>
							<a href="team-list.html" title="Project Team">Project Team </a>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</footer>
		
	<div class="container subfooter">
		<div class="row">
			<div class="span12">
				<p class="pull-right"><a href="#">Back to top</a></p>
				<p class="copyright">Copyright &copy;2017. All Rights Reserved.</p>
			</div>
		</div>
	</div>

	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->

	<!-- Fallback jQuery loading from Google CDN:
	     http://stackoverflow.com/questions/1014203/best-way-to-use-googles-hosted-jquery-but-fall-back-to-my-hosted-library-on-go -->
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script type="text/javascript">
		if (typeof jQuery == 'undefined')
		{
			document.write(unescape("%3Cscript src='https://grizzly.java.net/js/jquery-1.8.3.min.js' type='text/javascript'%3E%3C/script%3E"));
		}
	</script>
	
	<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
	<script src="https://grizzly.java.net/js/lightbox.js"></script>
	<script src="https://grizzly.java.net/js/jquery.smooth-scroll.min.js"></script>
	<!-- back button support for smooth scroll -->
	<script src="https://grizzly.java.net/js/jquery.ba-bbq.min.js"></script>
	<script src="//yandex.st/highlightjs/7.3/highlight.min.js"></script>

	<script src="https://grizzly.java.net/js/reflow-skin.js"></script>
	
	</body>
</html>
